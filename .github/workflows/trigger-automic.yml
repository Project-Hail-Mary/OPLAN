name: Find Production Commit

on: [push]

jobs:
  find-production-commit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Find Production Commit
      run: |
        production_commit=$(git log --grep="PRODUCTION" -n 1 --format="%H" || echo "none")
        latest_commit=$(git rev-parse HEAD)
        previous_commit=$(git rev-parse HEAD~1)
        echo "Latest Commit SHA: $latest_commit"
        echo "latest_commit=$latest_commit" >> $GITHUB_ENV
        echo "Previous Commit SHA: $previous_commit"
        echo "previous_commit=$previous_commit" >> $GITHUB_ENV
        echo "Production Commit SHA: $production_commit"
        echo "production_commit=$production_commit" >> $GITHUB_ENV

        if [ "$production_commit" != "none" ]; then
          echo "Comparing Production Commit ($production_commit) with Latest Commit ($latest_commit)"
          git diff --name-only $production_commit $latest_commit > changes.txt
        else
          echo "No production commit found, using previous commit ($previous_commit) as baseline."
          git diff --name-only $previous_commit $latest_commit > changes.txt
        fi
