name: Find Production Commit

on: [push]

jobs:
  find-production-commit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        repository: Project-Hail-Mary/OPLAN

    - name: Set up Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Find Production Commit
      run: |
        production_commit=$(git log --grep="PRODUCTION" -n 1 --format="%H" || echo "none")
        latest_commit=$(git rev-parse HEAD)
        previous_commit=$(git rev-parse HEAD~1)
        echo "Latest Commit SHA: $latest_commit"
        echo "latest_commit=$latest_commit" >> $GITHUB_ENV
        echo "Previous Commit SHA: $previous_commit"
        echo "previous_commit=$previous_commit" >> $GITHUB_ENV
        echo "Production Commit SHA: $production_commit"
        echo "production_commit=$production_commit" >> $GITHUB_ENV

        if [ "$production_commit" != "none" ]; then
          echo "Comparing Production Commit ($production_commit) with Latest Commit ($latest_commit)"
          git diff --name-only $production_commit $latest_commit > changes.txt
        else
          echo "No production commit found, using previous commit ($previous_commit) as baseline."
          git diff --name-only $previous_commit $latest_commit > changes.txt
        fi

    - name: Filter for Committed File
      run: |
        committed_file=$(git diff --name-only HEAD~1 HEAD)
        echo "Committed file: $committed_file"
        if grep -q "$committed_file" changes.txt; then
          echo "$committed_file" > changes.txt
        else
          echo "Committed file not found in changes, nothing to process."
          exit 0
        fi

    - name: Generate Diff Links
      run: |
        latest_commit=$(git rev-parse HEAD)
        diff_link="https://github.com/Project-Hail-Mary/OPLAN/compare/${previous_commit}...${latest_commit}"
        file_commit_link="https://github.com/Project-Hail-Mary/OPLAN/commit/${latest_commit}"
        echo "diff_link=$diff_link" >> $GITHUB_ENV
        echo "file_commit_link=$file_commit_link" >> $GITHUB_ENV

    - name: Call Automic
      run: |
        changes=$(cat changes.txt)
        payload=$(jq -n \
          --arg latest_commit "$latest_commit" \
          --arg previous_commit "$previous_commit" \
          --arg production_commit "$production_commit" \
          --arg changes "$changes" \
          '{latest_commit: $latest_commit, previous_commit: $previous_commit, production_commit: $production_commit, changes: $changes}')

        curl --location 'http://104.196.70.116:8088/ae/api/v1/103/executions' \
                --header 'Content-Type: application/json' \
                --user '103/UDM/UDM:udm' \
                --data "{\"object_name\": \"GITHUB.PRE.APPROVE\", \"inputs\": {\"&FILE#\": \"${file_commit_link}\", \"&DIFF_LINK#\": \"${diff_link}\", \"&LATEST_COMMIT_SHA#\": \"${latest_commit}\"}}"
